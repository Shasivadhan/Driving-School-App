<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Session Attendance - KsvTech Driving School</title>

    <link th:href="@{/css/bootstrap.min.css}"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <!-- Use admin dashboard -->
        <a class="navbar-brand" th:href="@{/admin/dashboard}">KsvTech Driving School</a>
        <span class="navbar-text text-white ms-auto">
            Session Attendance
        </span>
    </div>
</nav>

<div class="container py-4">

    <!-- Success message -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}">Success</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Error message -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}">Error</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Session header -->
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
            <h3 class="mb-1">Session Attendance</h3>
            <div class="text-muted small">
                <span th:text="${#temporals.format(session.sessionDate, 'dd-MM-yyyy')}">24-11-2025</span>
                &middot;
                <span th:text="${#temporals.format(session.startTime, 'HH:mm') + ' - ' +
                               #temporals.format(session.endTime, 'HH:mm')}">
                    07:00 - 08:00
                </span>
                <br>
                Batch:
                <span th:text="${session.batch != null ? session.batch.name : '-'}">Morning LMV</span>
                &middot;
                Instructor:
                <span th:text="${session.instructor != null ? ('Instructor #' + session.instructor.id) : '-'}">
                    Instructor #1
                </span>
                &middot;
                Vehicle:
                <span th:text="${session.vehicle != null ? session.vehicle.registrationNumber : '-'}">
                    KA01AB1234
                </span>
            </div>
        </div>

        <a class="btn btn-outline-secondary" th:href="@{/admin/sessions}">
            Back to Sessions
        </a>
    </div>

    <!-- Add attendance form -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">Add / Update Attendance</h5>
        </div>
        <div class="card-body">
            <!-- IMPORTANT: use sessionId from model, not session.id -->
            <form th:action="@{/admin/sessions/{id}/attendance(id=${sessionId})}"
                  method="post" class="row gy-2 gx-3 align-items-end">

                <input type="hidden"
                       th:name="${_csrf.parameterName}"
                       th:value="${_csrf.token}" />

                <div class="col-md-4">
                    <label class="form-label">Student</label>
                    <select class="form-select" name="studentId" required>
                        <option value="">-- Select Student --</option>
                        <option th:each="st : ${students}"
                                th:value="${st.id}"
                                th:text="${st.fullName}">
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="status" required>
                        <option value="">-- Select Status --</option>
                        <option th:each="st : ${statuses}"
                                th:value="${st.name()}"
                                th:text="${st.name()}">
                        </option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Remarks</label>
                    <input type="text" class="form-control" name="remarks"
                           placeholder="Optional remarks">
                </div>

                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Attendance list -->
    <div class="card shadow-sm">
        <div class="card-header">
            <h5 class="mb-0">Existing Attendance</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0 align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Student</th>
                        <th>Status</th>
                        <th>Remarks</th>
                        <th class="text-end">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(attendanceList)}">
                        <td colspan="5" class="text-center text-muted py-3">
                            No attendance records yet.
                        </td>
                    </tr>
                    <tr th:each="a,iter : ${attendanceList}">
                        <td th:text="${iter.index + 1}">1</td>
                        <td th:text="${a.student != null ? a.student.fullName : '-'}">Student</td>
                        <td th:text="${a.status}">PRESENT</td>
                        <td th:text="${a.remarks}">-</td>
                        <td class="text-end">
                            <form th:action="@{/admin/sessions/attendance/{aid}/delete(aid=${a.id})}"
                                  method="post" class="d-inline">
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                                <!-- use sessionId again -->
                                <input type="hidden" name="sessionId" th:value="${sessionId}"/>
                                <button type="submit"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Delete this attendance record?');">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
